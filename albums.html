<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>アルバム</title>
<style>
:root{--brand:#e60033;--ink:#222;--muted:#666;--line:#e8e8e8;--bg:#f6f7f8;--card:#fff;--shadow:0 8px 24px rgba(0,0,0,.06)}
*{box-sizing:border-box}html,body{margin:0}
body{background:var(--bg);color:var(--ink);font:14px/1.65 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
a{color:inherit;text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:0 14px}
header.site{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--line)}
.header-inner{display:flex;align-items:center;gap:12px;padding:10px 0}
.logo{display:flex;align-items:center;gap:10px;font-weight:900;color:var(--brand)}
.logo-mark{width:24px;height:24px;border-radius:6px;background:linear-gradient(135deg,#ff4a6e,var(--brand))}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{height:34px;padding:0 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.sm{height:28px;padding:0 8px;font-size:.9rem}
.h2{font-weight:900;margin:14px 0 8px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.tab{padding:6px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{border-color:var(--brand);color:var(--brand)}

.tools{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.search{display:grid;grid-template-columns:1fr 180px 160px 160px auto auto;gap:8px;margin:10px 0}
.search input,.search select{height:42px;border:1px solid var(--line);border-radius:999px;padding:0 12px}
@media (max-width:980px){.search{grid-template-columns:1fr 1fr 1fr}}
@media (max-width:640px){.search{grid-template-columns:1fr}}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0}
@media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
@media (max-width:800px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:520px){.grid{grid-template-columns:1fr}}

.card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
.thumb{position:relative;background:#f4f4f4;aspect-ratio:4/3;display:grid;place-items:center}
.thumb img{width:100%;height:100%;object-fit:contain;background:transparent}
.meta{padding:10px;display:grid;gap:6px}
.title{font-weight:900}
.sub{color:#666}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:.86rem;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#555;cursor:pointer}
.ops{display:flex;gap:6px;flex-wrap:wrap;margin:8px 10px 12px 10px}
.sep{color:#bbb}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:.86rem;color:#555}
.badge.pin{border-color:#ffb400;background:#fff6d7}
.album-head{display:flex;justify-content:space-between;align-items:center;margin-top:18px}
.album-name{font-weight:900}
.album-count{color:#777}

.empty{color:#777;border:1px dashed var(--line);background:#fff;padding:12px;border-radius:8px}

/* Lightbox */
.lb{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;z-index:100}
.lb.show{display:grid;place-items:center}
.lb-inner{position:relative;max-width:92vw;max-height:86vh;display:grid;gap:8px}
.lb figure{margin:0}
.lb img{max-width:92vw;max-height:68vh;object-fit:contain;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.5)}
.lb .caption{color:#fff}
.lb .nav{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
.lb .nav button{pointer-events:auto;background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:50%;width:44px;height:44px;cursor:pointer}
.lb .close{position:absolute;top:-10px;right:-10px;background:#000;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:6px 10px;cursor:pointer}

footer{margin-top:26px;background:#fff;border-top:1px solid var(--line)}
.footer-links{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 0}
.copyright{border-top:1px solid var(--line);color:#777;padding:12px 0;font-size:.88rem}
.small{font-size:.9rem;color:#777}

/* 原寸表示モードでは contain に */
.fit-contain .thumb img{ object-fit:contain; background:#fff }

/* スクリーンリーダー用（display:none は使わない） */
.visually-hidden{
  position:absolute;width:1px;height:1px;padding:0;margin:-1px;border:0;
  overflow:hidden;clip:rect(0 0 0 0);clip-path:inset(50%);white-space:nowrap;
}

.admin-only { display:none !important; }
.is-admin .admin-only { display: initial !important; }
.is-admin .admin-only.block { display:block !important; }
</style>


</head>

<body>
<header class="site">
  <div class="container header-inner">
    <a class="logo" href="index.html"><span class="logo-mark"></span><span>長峰実央</span></a>
    <div class="actions" style="margin-left:auto">
      <a class="btn" href="history.html">履歴</a>
      <a class="btn" href="units.html">取得単位</a>
      <a class="btn" href="comments.html">論文のコメント</a>
      <a class="btn" href="albums.html">アルバム</a>
      <a class="btn primary" href="links.html">リンク集</a>
    </div>
  </div>
</header>

<main class="container">
  <div class="h2">アルバム</div>

  <div class="tabs">
    <button class="tab active" id="tab-all">すべての写真</button>
    <button class="tab" id="tab-albums">アルバム一覧</button>

    <div class="tools">
      <button class="btn admin-only" id="btn-add" type="button">写真を追加</button>
      <<label class="btn admin-only" id="btn-add-file" for="file-input">画像ファイルから追加</label>
      <input type="file" id="file-input" accept="image/*" multiple class="visually-hidden">
      <button class="btn" id="btn-fit">表示：トリミング</button>
      <button class="btn admin-only" id="btn-export">エクスポート</button>
      <label class="btn admin-only" for="imp" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        インポート<input id="imp" type="file" accept="application/json" style="display:none">
      </label>
    </div>
  </div>

  <form class="search" onsubmit="event.preventDefault(); doSearch()">
    <input id="q" placeholder="検索（タイトル／説明／アルバム／タグ）" aria-label="検索">
    <select id="album"><option value="">全アルバム</option></select>
    <select id="sort">
      <option value="date_desc">日付が新しい順</option>
      <option value="updated_desc">更新が新しい順</option>
      <option value="title_asc">タイトル昇順</option>
    </select>
    <select id="pinned">
      <option value="">すべて</option>
      <option value="1">ピンのみ</option>
    </select>
    <button class="btn" type="submit">検索</button>
    <button class="btn" type="button" onclick="clearSearch()">クリア</button>
  </form>

  <!-- すべての写真 -->
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">まだ写真がありません。上の「写真を追加」から登録してください。</div>

  <!-- アルバム一覧 -->
  <div id="albums" style="display:none"></div>
</main>

<footer>
  <div class="container footer-links" id="footer-links"></div>
  <div class="container copyright">© 2025 Mao Nagamine</div>
</footer>

<!-- Lightbox -->
<div id="lightbox" class="lb" aria-hidden="true">
  <div class="lb-inner">
    <button class="close" id="lb-close">閉じる ✕</button>
    <div class="nav"><button id="lb-prev">‹</button><button id="lb-next">›</button></div>
    <figure><img id="lb-img" alt=""></figure>
    <div class="caption" id="lb-cap"></div>
  </div>
</div>

<script>
// 画面密度に応じた高品質サムネ設定
const DPR = window.devicePixelRatio || 1;
const THUMB_MAX = Math.min(1280, Math.round(640 * DPR)); // 例: DPR=2なら ~1280px
const THUMB_Q   = 0.92; // 品質（0.85→0.92へアップ）


/* ========= 0) フッター ========= */
const FOOTER_LINKS=[
  {label:'ホーム',href:'index.html'},
  {label:'履歴',href:'history.html'},
  {label:'取得単位',href:'units.html'},
  {label:'論文のコメント',href:'comments.html'},
  {label:'リンク集',href:'links.html'},
  {label:'アルバム',href:'albums.html'},
  {label:'お問い合わせ',href:'mailto:nagamine.mao.d9@elms.hokudai.ac.jp'}
];
function renderFooter(){
  const nav=document.getElementById('footer-links'); if(!nav) return;
  nav.innerHTML = FOOTER_LINKS.map((x,i)=>`
    <a href="${x.href}" ${x.target?`target="${x.target}" rel="noopener"`:''}>${x.label}</a>
    ${i<FOOTER_LINKS.length-1?'<span class="sep">/</span>':''}
  `).join('');
}
document.addEventListener('DOMContentLoaded', renderFooter);

/* ========= 1) 保存先とユーティリティ ========= */
const LSK='photos_v1', TS=LSK+'__ts';
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
const keep=v=> (v!=null && String(v).trim()!=='') ? String(v).trim() : null;
const load = ()=> { try{return JSON.parse(localStorage.getItem(LSK)||'[]')}catch(_){return[]} };
const save = (arr)=>{
  const slim = arr.map(({id,title,date,album,tags,desc,pinned,home,created,updated,thumb64})=>({
    id,title,date,album,tags,desc,pinned,home,created,updated,thumb64
  }));
  localStorage.setItem(LSK, JSON.stringify(slim));
  localStorage.setItem(TS, String(Date.now()));
};
const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});
function dataURLtoBlob(d){ if(typeof d!=='string'||!d.startsWith('data:image')) return null;
  const [m,b64]=d.split(','), mime=(m.match(/data:(.*?);/)||[])[1]||'image/jpeg';
  const bin=atob(b64), u8=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8],{type:mime});
}
const makeThumb=(dataURL,maxW=THUMB_MAX,q=THUMB_Q)=>new Promise(resolve=>{
  const img=new Image(); img.onload=()=>{
    const s=img.width>maxW? maxW/img.width : 1, w=Math.round(img.width*s), h=Math.round(img.height*s);
    const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
    resolve(c.toDataURL('image/jpeg', q));
  }; img.onerror=()=>resolve(dataURL); img.src=dataURL;
});

/* ========= 2) IndexedDB（画像本体） ========= */
const DBN='photos_db', STN='images';
function openDB(){ return new Promise((resolve,reject)=>{
  const r=indexedDB.open(DBN,1);
  r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(STN)) db.createObjectStore(STN,{keyPath:'id'});};
  r.onsuccess=()=>resolve(r.result); r.onerror=()=>reject(r.error);
});}
async function dbPut(id,fullBlob,thumbBlob){ const db=await openDB(); await new Promise((res,rej)=>{
  const tx=db.transaction(STN,'readwrite'), st=tx.objectStore(STN);
  st.put({id,full:fullBlob||null,thumb:thumbBlob||null}); tx.oncomplete=res; tx.onerror=()=>rej(tx.error);
});}
async function dbGet(id){ const db=await openDB(); return await new Promise((res,rej)=>{
  const tx=db.transaction(STN,'readonly'), st=tx.objectStore(STN), rq=st.get(id);
  rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error);
});}
window.__albums_dbPut=dbPut; window.__albums_dbGet=dbGet;

/* ========= 3) 検索・並び替え ========= */
function qval(){return (document.getElementById('q')?.value||'').trim().toLowerCase();}
function albumval(){return (document.getElementById('album')?.value||'').trim();}
function sortval(){return (document.getElementById('sort')?.value||'updated_desc').trim();}
function pinnedval(){return (document.getElementById('pinned')?.value||'').trim();}
function hit(x,q){
  if(!q) return true;
  const hay = [x.title,x.desc,x.album,(x.tags||[]).join(' ')].join(' ').toLowerCase();
  return hay.includes(q);
}
function doSearch(){
  sessionStorage.setItem('ph_q', qval());
  sessionStorage.setItem('ph_album', albumval());
  sessionStorage.setItem('ph_sort', sortval());
  sessionStorage.setItem('ph_pin', pinnedval());
  render();
}
function clearSearch(){
  document.getElementById('q').value='';
  document.getElementById('album').value='';
  document.getElementById('sort').value='date_desc';
  document.getElementById('pinned').value='';
  ['ph_q','ph_album','ph_sort','ph_pin'].forEach(k=>sessionStorage.removeItem(k));
  render();
}

/* ========= 4) 表示（カード/アルバム） ========= */
function tagHtml(tags){ return (tags||[]).map(t=>`<span class="tag" data-tag="${t}">#${t}</span>`).join(''); }
function card(x,i){ return `
<div class="card" data-id="${x.id}" data-i="${i}">
  <a class="thumb" href="#" data-act="open" title="クリックで拡大">
  <img ${x.thumb64 ? `src="${x.thumb64}" data-hydrated="1"` : `data-hydrated="0"`}
     alt="" data-photo-id="${x.id}">
 </a>
  <div class="meta">
    <div class="title">
      ${x.title || '(無題)'}
      ${x.pinned ? '<span class="badge pin">PIN</span>' : ''}
      ${x.home   ? '<span class="badge" style="border-color:#0b7;color:#0b7">HOME</span>' : ''}
    </div>
    <div class="sub">${x.album || ''} ${x.date ? `｜ ${x.date}` : ''}</div>
    ${x.desc ? `<div class="small" style="white-space:pre-wrap">${x.desc}</div>` : ''}
    <div class="tags">${tagHtml(x.tags)}</div>
  </div>
  <div class="ops admin-only block"
    <button class="btn sm" data-act="pin">${x.pinned ? 'ピン解除' : 'ピン留め'}</button>
    <button class="btn sm" data-act="home">${x.home ? 'ホーム解除' : 'ホームに表示'}</button>
    <button class="btn sm" data-act="edit">編集</button>
    <button class="btn sm" data-act="del">削除</button>
  </div>
</div>`; }

function refillAlbumSelect(){
  const sel = document.getElementById('album');
  const arr = load();
  const names = Array.from(new Set(arr.map(x=>x.album).filter(Boolean))).sort();
  sel.innerHTML = `<option value="">全アルバム</option>` + names.map(n=>`<option>${n}</option>`).join('');
}

function renderAll(){
  const arr = load();
  // フィルタ復元
  const qs = sessionStorage.getItem('ph_q')||'';
  const alb= sessionStorage.getItem('ph_album')||'';
  const so = sessionStorage.getItem('ph_sort')||'date_desc';
  const pv = sessionStorage.getItem('ph_pin')||'';
  document.getElementById('q').value=qs;
  document.getElementById('album').value=alb;
  document.getElementById('sort').value=so;
  document.getElementById('pinned').value=pv;

  const q = qs.toLowerCase();
  let filtered = arr.filter(x => hit(x,q) && (!alb || x.album===alb) && (!pv || x.pinned));
  filtered.sort((a,b)=>{
    if(so==='updated_desc'){
      const ua=(a.updated||a.created||'').toString(), ub=(b.updated||b.created||'').toString();
      return ub.localeCompare(ua);
    }
    if(so==='title_asc') return (a.title||'').localeCompare(b.title||'');
    return (b.date||'').localeCompare(a.date||''); // date_desc
  });

  document.getElementById('grid').innerHTML = filtered.map((x,i)=>card(x,i)).join('');
  document.getElementById('empty').style.display = filtered.length? 'none':'block';
  hydratePhotos(document);
}

function renderAlbums(){
  const arr = load();
  const byAlb = new Map();
  arr.forEach(x=>{
    const k = x.album||'（未分類）';
    if(!byAlb.has(k)) byAlb.set(k, []);
    byAlb.get(k).push(x);
  });
  const html = [...byAlb.entries()].sort((a,b)=> b[1].length - a[1].length).map(([name,list])=>`
    <section>
      <div class="album-head">
        <div class="album-name">${name}</div>
        <div class="album-count">${list.length} 枚</div>
      </div>
      <div class="grid">
        ${list.slice(0,8).map(x=>`
          <a class="thumb" href="#" data-open-id="${x.id}" title="${(x.title||'').replace(/"/g,'&quot;')}">
            <img ${x.thumb64 ? `src="${x.thumb64}" data-hydrated="1"` : `data-hydrated="0"`}
     alt="" data-photo-id="${x.id}">
          </a>
        `).join('')}
      </div>
    </section>
  `).join('');
  document.getElementById('albums').innerHTML = html || `<div class="empty">まだアルバムがありません。写真にアルバム名を設定するとここに表示されます。</div>`;
  hydratePhotos(document.getElementById('albums'));
}

/* ========= 5) 画像注入（IDB→<img src> + 欠損時の復旧UI） ========= */
async function hydratePhotos(scope=document){
  const imgs = scope.querySelectorAll('img[data-photo-id][data-hydrated!="1"]');
  for (const img of imgs) {
    const id = img.getAttribute('data-photo-id');
    try{
      const rec = await dbGet(id);
      // 1) まずサムネがあれば即表示（チラつき防止）
      if (rec?.thumb){ img.src = URL.createObjectURL(rec.thumb); img.dataset.hydrated='1'; }
      else if (rec?.full){ img.src = URL.createObjectURL(rec.full); img.dataset.hydrated='1'; }
      else {
        // 画像が見つからない → グレーの枠と再添付ボタンを表示
        const wrap = img.closest('.thumb');
        if (wrap && !wrap.querySelector('[data-fix]')) {
          wrap.innerHTML = `
            <div style="text-align:center;color:#777;padding:8px">
              <div style="font-size:12px;margin-bottom:6px">画像データが見つかりません</div>
              <button class="btn sm admin-only" data-fix="${id}">再添付</button>
            </div>`;
        }
      }

      // 2) Retina もしくは表示幅が大きい場合はフル画像にアップグレード
      if (rec?.full){
        const needHi = (DPR > 1.25) || (img.clientWidth && img.clientWidth * DPR > THUMB_MAX - 1);
        if (needHi){
          const fullURL = URL.createObjectURL(rec.full);
          (window.requestIdleCallback || setTimeout)(()=>{ img.src = fullURL; }, 0);
        }
      }
    }catch(_){}
  }
}



/* ========= 6) Lightbox ========= */
let lbIndex=-1, lbList=[];
async function openLightbox(fromIndex){
  lbIndex = fromIndex; lbList = lbList.length? lbList : load();
  const x = lbList[lbIndex]; if(!x){ closeLightbox(); return; }
  try{
    const rec = await dbGet(x.id);
    const blob = rec?.full || rec?.thumb;
    document.getElementById('lb-img').src = blob ? URL.createObjectURL(blob) : '';
  }catch(_){ document.getElementById('lb-img').src = ''; }
  document.getElementById('lb-cap').textContent =
    [x.title||'', x.album?`（${x.album}）`:'' , x.date||''].filter(Boolean).join(' ');
  const lb=document.getElementById('lightbox'); lb.classList.add('show'); lb.setAttribute('aria-hidden','false');
}
function closeLightbox(){ const lb=document.getElementById('lightbox'); lb.classList.remove('show'); lb.setAttribute('aria-hidden','true'); lbIndex=-1; lbList=[]; }
function lbNext(){ if(lbIndex<lbList.length-1) openLightbox(lbIndex+1); }
function lbPrev(){ if(lbIndex>0) openLightbox(lbIndex-1); }
document.getElementById('lb-close').onclick=closeLightbox;
document.getElementById('lb-next').onclick=lbNext;
document.getElementById('lb-prev').onclick=lbPrev;
document.getElementById('lightbox').onclick=(e)=>{ if(e.target.id==='lightbox') closeLightbox(); };
document.addEventListener('keydown',(e)=>{ const open=document.getElementById('lightbox').classList.contains('show'); if(!open) return;
  if(e.key==='Escape') closeLightbox(); if(e.key==='ArrowRight') lbNext(); if(e.key==='ArrowLeft') lbPrev();
});

/* ========= 7) 追加・編集・削除 ========= */
let SINGLE_META=null;
function handleAddClick(){
  const id=uid(), now=new Date().toISOString();
  SINGLE_META={id,title:'',date:'',album:'',tags:[],desc:'',pinned:false,home:false,created:now,updated:now};
  const input=document.getElementById('file-input');
  if (input?.showPicker) input.showPicker(); else input?.click();
}
async function handleFileChange(e){
  const files=Array.from(e.target.files||[]); if(!files.length) return;
  const arr=load();

  // 1枚（「写真を追加」経由）
  if (SINGLE_META){
    const f=files[0];
    const data=await fileToDataURL(f);
    const th=await makeThumb(data,480);
    await dbPut(SINGLE_META.id, dataURLtoBlob(data), dataURLtoBlob(th));
    const t = prompt('タイトル', f.name.replace(/\.[^.]+$/,'')); if(t===null){ SINGLE_META=null; e.target.value=''; return; }
    const d = prompt('日付（YYYY-MM または YYYY-MM-DD）',''); if(d===null){ SINGLE_META=null; e.target.value=''; return; }
    const a = prompt('アルバム名（例：研究、イベント、旅行）',''); if(a===null){ SINGLE_META=null; e.target.value=''; return; }
    const tg= prompt('タグ（カンマ区切り）',''); if(tg===null){ SINGLE_META=null; e.target.value=''; return; }
    const ds= prompt('説明（任意）',''); if(ds===null){ SINGLE_META=null; e.target.value=''; return; }
    arr.push({...SINGLE_META, title:keep(t)||'(無題)', date:keep(d)||'', album:keep(a)||'',
      thumb64: th,
      tags:keep(tg)? keep(tg).split(',').map(s=>s.trim()).filter(Boolean):[], desc: ds??'', updated:new Date().toISOString()});
    save(arr); SINGLE_META=null; e.target.value='';
    render(); renderAlbums(); hydratePhotos(document);
    alert('写真を追加しました'); return;
  }

  // 複数（「画像ファイルから追加」）
  const askEach = files.length>1 ? confirm('各ファイルのタイトル等を個別に入力しますか？（OK＝1枚ずつ入力／キャンセル＝ファイル名をタイトルに一括）') : false;
  const now=new Date().toISOString();
  for (const f of files){
    const id=uid();
    const data=await fileToDataURL(f);
    const th=await makeThumb(data,480);
    await dbPut(id, dataURLtoBlob(data), dataURLtoBlob(th));
    let meta;
    if (askEach){
      const t=prompt(`タイトル（${f.name}）`, f.name.replace(/\.[^.]+$/,'')); if(t===null) continue;
      const d=prompt('日付（YYYY-MM または YYYY-MM-DD）',''); if(d===null) continue;
      const a=prompt('アルバム名（例：研究、イベント、旅行）',''); if(a===null) continue;
      const tg=prompt('タグ（カンマ区切り）',''); if(tg===null) continue;
      const ds=prompt('説明（任意）',''); if(ds===null) continue;
      meta={id, title:keep(t)||'(無題)', date:keep(d)||'', album:keep(a)||'',
            tags:keep(tg)? keep(tg).split(',').map(s=>s.trim()).filter(Boolean):[],
            desc:ds??'', pinned:false, home:false, created:now, updated:now};
    }else{
      meta={id, title:f.name.replace(/\.[^.]+$/,''), date:'', album:'', tags:[], desc:'',
            thumb64: th,
            pinned:false, home:false, created:now, updated:now};
    }
    arr.push(meta);
  }
  save(arr); e.target.value='';
  render(); renderAlbums(); hydratePhotos(document);
  alert('写真を追加しました');
}

// 編集（画像差し替えは別フロー。ここではメタのみ）
function editPhoto(obj){
  const t  = prompt('タイトル', obj.title??''); if(t===null) return null;
  const d  = prompt('日付（YYYY-MM または YYYY-MM-DD）', obj.date??''); if(d===null) return null;
  const a  = prompt('アルバム名（例：研究、イベント、旅行）', obj.album??''); if(a===null) return null;
  const tg = prompt('タグ（カンマ区切り）', (obj.tags||[]).join(',')); if(tg===null) return null;
  const ds = prompt('説明（任意）', obj.desc??''); if(ds===null) return null;
  return {
    ...obj,
    title:keep(t)||'(無題)', date:keep(d)||'', album:keep(a)||'',
    tags:keep(tg)? keep(tg).split(',').map(s=>s.trim()).filter(Boolean):[],
    desc:ds??'', updated:new Date().toISOString()
  };
}

/* ========= 8) イベント配線 ========= */
// グリッド操作
document.getElementById('grid').onclick = (ev)=>{
  const card = ev.target.closest('.card'); if(!card) return;
  const id = card.dataset.id;
  const arr = load();
  const ix = arr.findIndex(x=>x.id===id); if(ix<0) return;

  const actBtn = ev.target.closest('button[data-act]');
  if(actBtn){
    const act = actBtn.dataset.act;
    if (act==='home'){ arr[ix].home=!arr[ix].home; arr[ix].updated=new Date().toISOString(); save(arr); render(); return; }
    if (act==='pin'){  arr[ix].pinned=!arr[ix].pinned; arr[ix].updated=new Date().toISOString(); save(arr); render(); return; }
    if (act==='edit'){ const o=editPhoto(arr[ix]); if(!o) return; arr[ix]=o; save(arr); render(); return; }
    if (act==='del'){ if(!confirm('この写真を削除しますか？')) return; arr.splice(ix,1); save(arr); render(); return; }
    return;
  }

  // サムネ→Lightbox
  const open = ev.target.closest('[data-act="open"]');
  if(open){
    // 現フィルタでの一覧を組み直して渡す
    const qs = sessionStorage.getItem('ph_q')||'';
    const alb= sessionStorage.getItem('ph_album')||'';
    const so = sessionStorage.getItem('ph_sort')||'date_desc';
    const pv = sessionStorage.getItem('ph_pin')||'';
    const q = qs.toLowerCase();
    let filtered = arr.filter(x => hit(x,q) && (!alb || x.album===alb) && (!pv || x.pinned));
    filtered.sort((a,b)=>{
      if(so==='updated_desc'){
        const ua=(a.updated||a.created||'').toString(), ub=(b.updated||b.created||'').toString();
        return ub.localeCompare(ua);
      }
      if(so==='title_asc') return (a.title||'').localeCompare(b.title||'');
      return (b.date||'').localeCompare(a.date||'');
    });
    lbList = filtered;
    const startIndex = filtered.findIndex(x=>x.id===id);
    openLightbox(startIndex>=0?startIndex:0);
  }

  // タグ→検索
  const tag = ev.target.closest('.tag');
  if(tag){ const q=document.getElementById('q'); q.value=tag.dataset.tag; doSearch(); }
};

// アルバム一覧クリック→Lightbox（そのアルバム全体を対象に）
document.getElementById('albums').onclick = (ev)=>{
  const a = ev.target.closest('[data-open-id]'); if(!a) return;
  const id = a.getAttribute('data-open-id');
  const arr = load();
  const card = arr.find(x=>x.id===id);
  const al  = card?.album || '';
  lbList = arr.filter(x=> (x.album||'') === al);
  const startIndex = lbList.findIndex(x=>x.id===id);
  openLightbox(startIndex>=0?startIndex:0);
};

// タブ切替
document.getElementById('tab-all')?.addEventListener('click', ()=>{
  document.getElementById('tab-all')?.classList.add('active');
  document.getElementById('tab-albums')?.classList.remove('active');
  document.getElementById('grid').style.display='';
  document.getElementById('empty').style.display='';
  document.getElementById('albums').style.display='none';
  render();
});
document.getElementById('tab-albums')?.addEventListener('click', ()=>{
  document.getElementById('tab-albums')?.classList.add('active');
  document.getElementById('tab-all')?.classList.remove('active');
  document.getElementById('grid').style.display='none';
  document.getElementById('empty').style.display='none';
  document.getElementById('albums').style.display='';
  renderAlbums();
});

// ボタン配線
document.getElementById('btn-add')?.addEventListener('click', handleAddClick);
document.getElementById('file-input')?.addEventListener('change', handleFileChange);

// エクスポート
document.getElementById('btn-export').onclick = ()=>{
  const blob = new Blob([JSON.stringify(load(),null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='photos_data.json'; a.click(); URL.revokeObjectURL(a.href);
};

// 表示モード（cover/contain）
(function(){
  const key='photos_fit';
  const saved=localStorage.getItem(key)||'contain';
  if(saved==='contain') document.documentElement.classList.add('fit-contain');
  const btn=document.getElementById('btn-fit');
  if(btn){
    const set=()=> btn.textContent = document.documentElement.classList.contains('fit-contain')? '表示：原寸（contain）':'表示：トリミング（cover）';
    set();
    btn.onclick=()=>{
      document.documentElement.classList.toggle('fit-contain');
      localStorage.setItem(key, document.documentElement.classList.contains('fit-contain')?'contain':'cover');
      set();
    };
  }
})();

/* ========= 9) 初期化 ========= */
function render(){ refillAlbumSelect(); renderAll(); }
document.addEventListener('DOMContentLoaded', ()=>{
  // 検索条件の復元
  const set=(id,key,def='')=>{ const v=sessionStorage.getItem(key); const el=document.getElementById(id); if(el) el.value=(v!=null?v:def); };
  set('q','ph_q'); set('album','ph_album'); set('sort','ph_sort','date_desc'); set('pinned','ph_pin','');
  render();
  // Mutation で画像注入を補助
  new MutationObserver(()=> hydratePhotos(document)).observe(document.getElementById('grid')||document.body,{childList:true,subtree:true});
});
// 他タブでの更新を反映
window.addEventListener('storage', (e)=>{ if(e.key===TS){ render(); renderAlbums(); hydratePhotos(document); }});


/* ========= 欠損画像のその場復旧（再添付） ========= */
(function(){
  // クリック委任：gridとalbums両方で動く
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-fix]');
    if(!btn) return;
    e.preventDefault();
    const id = btn.getAttribute('data-fix');

    // 1) ファイル選択
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.accept = 'image/*';
    const file = await new Promise(ok=>{
      picker.onchange = ()=> ok(picker.files && picker.files[0]);
      picker.click();
    });
    if(!file) return;

    // 2) サムネ生成 & IDB登録
    const dataURL = await new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);});
    // 既存の makeThumb / dataURLtoBlob を使う
    const th = await makeThumb(dataURL, THUMB_MAX, THUMB_Q);
    await dbPut(id, dataURLtoBlob(dataURL), dataURLtoBlob(th));

    // 3) 画面をその場で更新
    //   - 同じカードを即座に再ハイドレート
    const card = document.querySelector(`.card[data-id="${id}"]`) || document.querySelector(`[data-open-id="${id}"]`)?.closest('.thumb');
    if (card){
      // 失われていた<img>を差し戻す
      const thumb = card.querySelector('.thumb');
      if (thumb) {
        thumb.innerHTML = `<img src="" alt="" data-photo-id="${id}" data-hydrated="0">`;
      }
    }
    hydratePhotos(document);
    alert('画像を再添付しました');
  });
})();

// 初回起動時に、thumb64 が無いものは IDB からサムネを作って埋める
(async function rebuildThumb64Once(){
  const key='__rebuilt_thumb64_v1';
  if (localStorage.getItem(key)) return;

  const arr = load(); if (!arr.length) { localStorage.setItem(key,'1'); return; }

  // Blob→DataURL
  const blobToDataURL = (blob)=> new Promise((ok,ng)=>{ const fr=new FileReader(); fr.onload=()=>ok(fr.result); fr.onerror=ng; fr.readAsDataURL(blob); });

  let changed=false;
  for (const m of arr){
    if (m.thumb64) continue;
    try{
      const rec  = await __albums_dbGet(m.id);
      const blob = rec?.thumb || rec?.full;
      if (!blob) continue;
      m.thumb64 = await blobToDataURL(blob);
      changed = true;
    }catch(_){}
  }
if (changed) {
    save(arr);
    localStorage.setItem(key,'1');
  }
})();

</script>

<script>
(function(){
  const p=new URLSearchParams(location.search);
  const isLocal = ['localhost','127.0.0.1'].includes(location.hostname)
               || location.protocol==='file:'
               || p.get('admin')==='1'
               || localStorage.getItem('admin')==='1';
  if(isLocal) document.documentElement.classList.add('is-admin');
  // Ctrl+Shift+E で切替
  addEventListener('keydown',e=>{
    if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='e'){
      const on=localStorage.getItem('admin')==='1';
      localStorage.setItem('admin', on?'0':'1'); location.reload();
    }
  });
})();
</script>

</body>
</html>
